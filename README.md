This version is rewritten in c++.
